---
layout: post
title: Look into eggcc
date: 2024-12-01 00:00:00
description:
tags:
categories:
tabs: true
thumbnail:
mermaid:
  enabled: true
  zoomable: true
toc:
  beginning: true
  # sidebar: left
pretty_table: true
tikzjax: true
pseudocode: true
---

# Eggcc

> I'm trying to use e-graph/eqsat/extract/... to do some compiler-involved stuff. The [eggcc](https://github.com/egraphs-good/eggcc) is a good starting point. And here is my note of it.
{: .block-tip}

## About

[eggcc](https://github.com/egraphs-good/eggcc) compiles [bril](https://github.com/uwplse/bril) to LLVMIR/cranelift. It is mainly hosted by UW PLSE lab (I guess, since the active contributors, including Oliver Flatt, Anjali Pal, and Yihong Zhang, are from the lab). The project is still under heavy development, and lacks open documentation. I found it very inspiring as a rewrite-based, more specifically [egglog](https://github.com/egraphs-good/egglog)-based compiler. So here is my note of it.

Related work:

- [jlm](https://github.com/phate/jlm): `RVSDG`-based compiler: `llvmir -> RVSDG -> llvmir/mlir/circt`;
- [optir](https://github.com/jameysharp/optir/):  proof-of-concept `RVSDG`-based compiler, use [egg](https://github.com/egraphs-good/egg) for optimization;


## Have the first try

Follow [eggcc's README](https://github.com/egraphs-good/eggcc)'s instruction for installation (which should be fine :smiley:), then run:

```
cargo run -- --debug-dir ./temp --run-mode optimize  <bril, e.g. ./tests/passing/small/loop_if.bril> 
```

Then, [eggcc](https://github.com/egraphs-good/eggcc) will generate the `temp` directory, holding some visualization files for `rvsdg`, `cfg`, and `dag`. And the optimized `bril` code will be printed to stdout.

Also, you can run (after some npm setup):

```
bash infra/localnightly.sh <bril file or directory>
cd nightly/output && python3 -m http.server
```

to get a local server for report and visualization of `eggcc`'s runs.


## How it works

> TODO
{: .block-tip}

### Main Loop

### RVSDG

In `src/rvsdg/mod.rs`:

| struct/enum | description                                        | members                      |
| ----------- | -------------------------------------------------- | ---------------------------- |
| `BasicExpr` | prim op, function call, const, effect (mem, print) | operands: `Vec<Op>`          |
| `Operand`   | region arg, region output                          | i-th arg/output, region `Id` |
| `RvsdgBody` | basic, if (0/1), gamma (switch), theta (do-while)  | holding `Operand`s           |

`rvsdg` format is imagelike, exprs and bodies are nodes, operands are edges.

here are two rvsdgs (represented in too-brief text), one unoptimized, one optimized, for the [if_in_loop.bril](https://github.com/egraphs-good/eggcc/blob/main/tests/passing/small/if_in_loop.bril) example:

```
// unoptimized
loop {
  if{}{}, print, print, add, if'{}{}
}
// optimized
loop {
  select, print, print, add
}

```

### DAG

`rvsdg->dag`: in `src/rvsdg/to_dag.rs`: `RvsdgProgram::to_dag_encoding`

`dag`: in `dag_in_context/schema.rs`

The `dag` format is a graph of expressions with contexts:

| struct/enum | description | members |
| --- | --- | --- |
| `TreeProgram` | program | entry, functions |
| `Expr` | expression, including func, loop, expr, ... | `RcExpr` as operands and results|
| `RcExpr`| expression as data | `Rc<Expr>` |
| `Assumption` | context, in-loop, in-if, ... | directly bound to consts, and args |

> For more details about `Assumption`, see `ASSUME` nodes in "Automating Constraint-Aware Datapath Optimization using E-Graphs. DAC 2023, doi: 10.1109/DAC56929.2023.0247797".


### Egglog Passes

